<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å’è«–ãƒ€ãƒ¼ãƒ“ãƒ¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'MS Gothic', 'Osaka-Mono', monospace;
            background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 30px 0;
            background: linear-gradient(90deg, #8B4513 0%, #A0522D 50%, #8B4513 100%);
            border: 3px solid #FFD700;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        h1 {
            font-size: 2.5em;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            letter-spacing: 5px;
        }

        .subtitle {
            color: #FFF8DC;
            margin-top: 10px;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 10px;
        }

        .tab {
            flex: 1;
            padding: 15px;
            background: linear-gradient(180deg, #4a7c59 0%, #2d5a3d 100%);
            border: 2px solid #FFD700;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
            transition: all 0.3s;
        }

        .tab:hover {
            background: linear-gradient(180deg, #5a8c69 0%, #3d6a4d 100%);
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(180deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            box-shadow: 0 4px 8px rgba(255, 215, 0, 0.4);
        }

        .content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 10px;
            color: #000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .content.active {
            display: block;
        }

        .race-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .race-table th {
            background: linear-gradient(180deg, #8B4513 0%, #654321 100%);
            color: #FFD700;
            padding: 15px;
            text-align: center;
            border: 2px solid #FFD700;
            font-size: 1.1em;
        }

        .race-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
            background: #fff;
        }

        .race-table tr:nth-child(even) td {
            background: #f9f9f9;
        }

        .race-table tr:hover td {
            background: #fff8dc;
        }

        .horse-number {
            font-weight: bold;
            font-size: 1.3em;
            color: #8B4513;
        }

        .odds {
            color: #FF4500;
            font-weight: bold;
            font-size: 1.1em;
        }

        .predictions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .prediction-card {
            background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #FFD700;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .prediction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #FFD700;
        }

        .prediction-author {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .prediction-type {
            background: #8B4513;
            color: #FFD700;
            padding: 6px 12px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .horse-info {
            background: #fff;
            padding: 12px;
            margin: 8px 0;
            border-radius: 5px;
            border-left: 4px solid #FFD700;
        }

        .horse-info-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .horse-number-badge {
            background: #8B4513;
            color: #FFD700;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
        }

        .horse-name {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }

        .horse-odds {
            margin-left: auto;
            color: #FF4500;
            font-weight: bold;
        }

        .horse-theme {
            color: #666;
            font-size: 0.9em;
            margin-left: 40px;
            line-height: 1.4;
        }

        .add-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: none;
            font-size: 2em;
            color: #fff;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }

        .add-button:hover {
            transform: scale(1.1);
            box-shadow: 0 7px 20px rgba(255, 215, 0, 0.5);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
        background: #fff;
        padding: 30px;
        border-radius: 10px;
        max-width: 500px;
        width: 90%;
        color: #000;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        max-height: 90vh;   /* ç”»é¢ã®é«˜ã•ã®90%ã‚’ä¸Šé™ã«ã™ã‚‹ */
        overflow-y: auto;   /* ä¸­èº«ãŒã¯ã¿å‡ºã—ãŸã‚‰ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’å‡ºã™ */
        position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            border: none;
            background: #ddd;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: #999;
            color: #fff;
        }

        .modal h2 {
            color: #8B4513;
            margin-bottom: 20px;
            text-align: center;
            padding-right: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #FFD700;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .button-group button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-submit {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 215, 0, 0.4);
        }

        .btn-cancel {
            background: #999;
            color: #fff;
        }

        .btn-cancel:hover {
            background: #777;
        }

        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .selection-btn {
            padding: 15px;
            border: 2px solid #ddd;
            background: #fff;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            text-align: left;
        }

        .selection-btn:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .selection-btn.selected {
            background: #FFD700;
            border-color: #FFA500;
            color: #000;
            box-shadow: 0 3px 10px rgba(255, 215, 0, 0.3);
        }

        .selection-btn-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .selection-btn-number {
            background: #8B4513;
            color: #FFD700;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
            flex-shrink: 0;
        }

        .selection-btn-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
            flex: 1;
        }

        .selection-btn-odds {
            color: #FF4500;
            font-weight: bold;
            font-size: 1.1em;
        }

        .selection-btn-theme {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
            line-height: 1.4;
        }

        .result-section {
            margin-top: 30px;
        }

        .result-item {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            color: #000;
            font-weight: bold;
            font-size: 1.2em;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .result-rank {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .result-horse-name {
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .result-theme {
            font-size: 0.9em;
            font-weight: normal;
            color: #555;
            margin-top: 5px;
            padding-left: 10px;
            border-left: 3px solid #8B4513;
        }
        .winner-card {
            background: linear-gradient(135deg, #fff5e6 0%, #fff 100%);
            border: 3px solid #ff4500; /* èµ¤æ ã§å¼·èª¿ */
            box-shadow: 0 0 15px rgba(255, 69, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        /* ã€Œçš„ä¸­ã€ã‚¹ã‚¿ãƒ³ãƒ—é¢¨ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .hit-badge {
            position: absolute;
            top: 10px;
            right: -30px;
            background: #ff4500;
            color: white;
            padding: 5px 40px;
            transform: rotate(45deg);
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .winner-name {
            font-size: 1.4em;
            font-weight: bold;
            color: #d32f2f;
            margin-bottom: 10px;
        }

        .winner-detail {
            background: #ffecb3;
            padding: 8px;
            border-radius: 5px;
            margin-top: 5px;
            color: #5d4037;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ† å’è«–ãƒ€ãƒ¼ãƒ“ãƒ¼ ğŸ†</h1>
            <p class="subtitle">ä»¤å’Œã®æ¿€æˆ¦ï¼å­¦å•ã®é ‚ç‚¹ã‚’ç›®æŒ‡ã›ï¼</p>
        </header>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('shutsuba')">å‡ºé¦¬è¡¨</div>
            <div class="tab" onclick="switchTab('yosou')">äºˆæƒ³ä¸€è¦§</div>
            <div class="tab" onclick="switchTab('kekka')">æœ€çµ‚çµæœ</div>
        </div>

        <div id="shutsuba" class="content active">
            <h2 style="color: #8B4513; text-align: center; margin-bottom: 20px;">ğŸ“‹ å‡ºé¦¬è¡¨</h2>
            <table class="race-table">
                <thead>
                    <tr>
                        <th>é¦¬ç•ª</th>
                        <th>é¦¬åï¼ˆãƒ¡ãƒ³ãƒãƒ¼ï¼‰</th>
                        <th>é¨æ‰‹</th>
                        <th>å’è«–ãƒ†ãƒ¼ãƒ</th>
                        <th>ã‚ªãƒƒã‚º</th>
                    </tr>
                </thead>
                <tbody id="horseTable">
                    <!-- ã“ã“ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ  -->
                </tbody>
            </table>
        </div>

        <div id="yosou" class="content">
            <h2 style="color: #8B4513; text-align: center; margin-bottom: 20px;">ğŸ¯ äºˆæƒ³ä¸€è¦§</h2>
            <div class="predictions-grid" id="predictionsGrid">
                <!-- äºˆæƒ³ã‚«ãƒ¼ãƒ‰ãŒè¿½åŠ ã•ã‚Œã‚‹ -->
            </div>
            <button class="add-button" onclick="openModal()">+</button>
        </div>

        <div id="kekka" class="content">
            <h2 style="color: #8B4513; text-align: center; margin-bottom: 20px;">ğŸŠ æœ€çµ‚çµæœç™ºè¡¨</h2>
            
            <div class="result-section" id="resultSection"></div>
        
            <div id="winnersArea" style="display: none; margin-top: 40px; border-top: 3px dashed #8B4513; padding-top: 20px;">
                <h2 style="color: #d32f2f; text-align: center; margin-bottom: 20px; text-shadow: 1px 1px 0 #fff;">ğŸ¯ çš„ä¸­è€…ä¸€è¦§ ğŸ¯</h2>
                <div class="predictions-grid" id="winnersGrid">
                    </div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">Ã—</button>
            <h2>äºˆæƒ³ã‚’è¿½åŠ </h2>
            <div class="form-group">
                <label>äºˆæƒ³è€…å</label>
                <input type="text" id="predictorName" placeholder="åå‰ã‚’å…¥åŠ›">
            </div>
            <div class="form-group">
                <label>åˆ¸ç¨®</label>
                <select id="betType" onchange="updateSelectionUI()">
                    <option value="å˜å‹">å˜å‹</option>
                    <option value="è¤‡å‹">è¤‡å‹</option>
                    <option value="3é€£å˜">3é€£å˜</option>
                    <option value="3é€£è¤‡">3é€£è¤‡</option>
                </select>
            </div>
            <div class="form-group">
                <label id="selectionLabel">é¦¬ç•ªã‚’é¸æŠ</label>
                <div class="selection-grid" id="selectionGrid">
                    <!-- é¦¬ç•ªãƒœã‚¿ãƒ³ãŒè¿½åŠ ã•ã‚Œã‚‹ -->
                </div>
            </div>
            <div class="button-group">
                <button class="btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-submit" onclick="addPrediction()">äºˆæƒ³ã‚’è¿½åŠ </button>
            </div>
        </div>
    </div>

    <script>
        // API_BASEã‚’å‹•çš„ã«è¨­å®šï¼ˆç¾åœ¨ã®ãƒ›ã‚¹ãƒˆã¨ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ï¼‰
        const API_BASE = `${window.location.protocol}//${window.location.host}/api`;
        
        let horses = [];
        let predictions = [];
        let results = [];
        let selectedNumbers = [];

        // APIå‘¼ã³å‡ºã—é–¢æ•°
        async function fetchHorses() {
            try {
                const response = await fetch(`${API_BASE}/horses`);
                horses = await response.json();
                initHorseTable();
            } catch (error) {
                console.error('å‡ºé¦¬ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                alert('å‡ºé¦¬ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        async function fetchPredictions() {
            try {
                const response = await fetch(`${API_BASE}/predictions`);
                predictions = await response.json();
                renderPredictions();
            } catch (error) {
                console.error('äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                alert('äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        async function fetchResults() {
            try {
                const response = await fetch(`${API_BASE}/results`);
                results = await response.json();
                initResults();
            } catch (error) {
                console.error('çµæœãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                alert('çµæœãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function initHorseTable() {
            const tbody = document.getElementById('horseTable');
            tbody.innerHTML = '';
            horses.forEach(horse => {
                const row = `
                    <tr>
                        <td class="horse-number">${horse.number}</td>
                        <td><strong>${horse.name}</strong></td>
                        <td>${horse.jockey || 'ï¼ˆæœªè¨­å®šï¼‰'}</td>
                        <td>${horse.theme}</td>
                        <td class="odds">${horse.odds}å€</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function initResults() {
            const section = document.getElementById('resultSection');
            section.innerHTML = '';
            
            if (results.length === 0) {
                section.innerHTML = '<p style="text-align:center;">çµæœã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
                document.getElementById('winnersArea').style.display = 'none';
                return;
            }

            // çµæœã®è¡¨ç¤ºï¼ˆæ—¢å­˜ã®å‡¦ç†ï¼‰
            results.forEach(result => {
                const medal = result.rank === 1 ? 'ğŸ¥‡' : result.rank === 2 ? 'ğŸ¥ˆ' : 'ğŸ¥‰';
                const horse = horses.find(h => h.number === result.horse_number); // åå‰ãƒãƒƒãƒã§ã¯ãªãIDãƒãƒƒãƒã®æ–¹ãŒå®‰å…¨ã§ã™ãŒã€å…ƒã®ã‚³ãƒ¼ãƒ‰ã«åˆã‚ã›ã¾ã™
                const horseName = horse ? horse.name : result.horse_name;
                const theme = horse ? horse.theme : 'ï¼ˆãƒ†ãƒ¼ãƒæƒ…å ±ãªã—ï¼‰';
                
                const item = `
                    <div class="result-item">
                        <div class="result-rank">${medal} ç¬¬${result.rank}ä½</div>
                        <div class="result-horse-name">${result.horse_number}ç•ª ${horseName}</div>
                        <div class="result-theme">${theme}</div>
                    </div>
                `;
                section.innerHTML += item;
            });

            // â˜…ã“ã“ã§çš„ä¸­åˆ¤å®šã‚’å®Ÿè¡Œ
            checkWinners();
        }

        function checkWinners() {
            const winnersGrid = document.getElementById('winnersGrid');
            const winnersArea = document.getElementById('winnersArea');
            winnersGrid.innerHTML = '';

            // çµæœãŒå‡ºã¦ã„ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
            if (results.length === 0) return;

            // çµæœãƒ‡ãƒ¼ã‚¿ã®æ•´ç†ï¼ˆ1ç€, 2ç€, 3ç€ã®é¦¬ç•ªã‚’å–å¾—ï¼‰
            const rank1 = results.find(r => r.rank === 1)?.horse_number;
            const rank2 = results.find(r => r.rank === 2)?.horse_number;
            const rank3 = results.find(r => r.rank === 3)?.horse_number;

            // 3ç€ã¾ã§ç¢ºå®šã—ã¦ã„ãªã„ã¨åˆ¤å®šã§ããªã„åˆ¸ç¨®ãŒã‚ã‚‹ãŸã‚ãƒã‚§ãƒƒã‚¯
            const top3 = [rank1, rank2, rank3].filter(n => n != null);

            let hitCount = 0;

            predictions.forEach(pred => {
                let isHit = false;
                const pNums = pred.numbers.map(n => parseInt(n)); // å¿µã®ãŸã‚æ•°å€¤åŒ–

                // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
                if (pred.bet_type === 'å˜å‹') {
                    // äºˆæƒ³ã—ãŸ1é ­ãŒ1ç€ãªã‚‰å½“ãŸã‚Š
                    if (rank1 && pNums[0] === rank1) isHit = true;

                } else if (pred.bet_type === 'è¤‡å‹') {
                    // äºˆæƒ³ã—ãŸ1é ­ãŒ3ç€ä»¥å†…ãªã‚‰å½“ãŸã‚Š
                    if (top3.includes(pNums[0])) isHit = true;

                } else if (pred.bet_type === '3é€£å˜') {
                    // 1ç€,2ç€,3ç€ã®é †ç•ªé€šã‚Šä¸€è‡´ãªã‚‰å½“ãŸã‚Š
                    if (rank1 && rank2 && rank3 && 
                        pNums[0] === rank1 && pNums[1] === rank2 && pNums[2] === rank3) {
                        isHit = true;
                    }

                } else if (pred.bet_type === '3é€£è¤‡') {
                    // é¸ã‚“ã 3é ­ãŒ1,2,3ç€ã«å«ã¾ã‚Œã¦ã„ã‚Œã°å½“ãŸã‚Šï¼ˆé †ä¸åŒï¼‰
                    if (rank1 && rank2 && rank3) {
                        const resultSet = new Set([rank1, rank2, rank3]);
                        const predSet = new Set(pNums);
                        // 3ã¤ã¨ã‚‚ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ï¼ˆé›†åˆã®å·®ãŒãªã„ã‹ï¼‰
                        if ([...predSet].every(num => resultSet.has(num))) {
                            isHit = true;
                        }
                    }
                }

                // çš„ä¸­æ™‚ã®è¡¨ç¤ºä½œæˆ
                if (isHit) {
                    hitCount++;
                    const card = document.createElement('div');
                    card.className = 'prediction-card winner-card';
                    
                    // é¦¬åã®å–å¾—ç”¨
                    const horseNames = pNums.map(num => {
                        const h = horses.find(horse => horse.number === num);
                        return h ? `${num}ç•ª ${h.name}` : `${num}ç•ª`;
                    }).join('<br>');

                    card.innerHTML = `
                        <div class="hit-badge">çš„ä¸­!</div>
                        <div class="winner-name">ğŸ‰ ${pred.predictor_name}</div>
                        <div class="prediction-type" style="display:inline-block; margin-bottom:5px;">${pred.bet_type}</div>
                        <div class="winner-detail">
                            ${horseNames}
                        </div>
                    `;
                    winnersGrid.appendChild(card);
                }
            });

            // çš„ä¸­è€…ãŒã„ã‚Œã°ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤ºã€ã„ãªã‘ã‚Œã°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if (hitCount > 0) {
                winnersArea.style.display = 'block';
            } else {
                winnersArea.style.display = 'block';
                winnersGrid.innerHTML = '<p style="width:100%; text-align:center; font-size:1.2em; color:#fff; background:rgba(0,0,0,0.5); padding:20px; border-radius:10px;">çš„ä¸­è€…ãªã—... æ³¢ä¹±ã®å±•é–‹ã§ã™ï¼ğŸŒªï¸</p>';
            }
        }
        function openModal() {
            document.getElementById('modal').classList.add('active');
            updateSelectionUI();
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            selectedNumbers = [];
            document.getElementById('predictorName').value = '';
        }

        function updateSelectionUI() {
            const betType = document.getElementById('betType').value;
            const grid = document.getElementById('selectionGrid');
            const label = document.getElementById('selectionLabel');
            
            selectedNumbers = [];
            grid.innerHTML = '';
            
            let maxSelect = 1;
            if (betType === 'è¤‡å‹') maxSelect = 1;
            else if (betType === '3é€£å˜' || betType === '3é€£è¤‡') maxSelect = 3;
            
            label.textContent = `é¦¬ã‚’é¸æŠï¼ˆ${betType === '3é€£å˜' || betType === '3é€£è¤‡' ? '3é ­' : '1é ­'}ï¼‰`;
            
            horses.forEach(horse => {
                const btn = document.createElement('div');
                btn.className = 'selection-btn';
                btn.setAttribute('data-horse-number', horse.number);
                btn.innerHTML = `
                    <div class="selection-btn-header">
                        <div class="selection-btn-number">${horse.number}</div>
                        <div class="selection-btn-name">${horse.name}</div>
                        <div class="selection-btn-odds">${horse.odds}å††</div>
                    </div>
                    <div class="selection-btn-theme">${horse.theme}</div>
                `;
                btn.onclick = () => selectHorse(horse.number, maxSelect);
                grid.appendChild(btn);
            });
        }

        function selectHorse(number, maxSelect) {
            const index = selectedNumbers.indexOf(number);
            
            if (index > -1) {
                selectedNumbers.splice(index, 1);
            } else {
                if (selectedNumbers.length < maxSelect) {
                    selectedNumbers.push(number);
                }
            }
            
            document.querySelectorAll('.selection-btn').forEach(btn => {
                btn.classList.remove('selected');
                const horseNumber = parseInt(btn.getAttribute('data-horse-number'));
                if (selectedNumbers.includes(horseNumber)) {
                    btn.classList.add('selected');
                }
            });
        }

        async function addPrediction() {
            const name = document.getElementById('predictorName').value;
            const betType = document.getElementById('betType').value;
            
            if (!name || selectedNumbers.length === 0) {
                alert('äºˆæƒ³è€…åã¨é¦¬ç•ªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const betTypeReq = betType === '3é€£å˜' || betType === '3é€£è¤‡' ? 3 : 1;
            if (selectedNumbers.length !== betTypeReq) {
                alert(`${betType}ã¯${betTypeReq}é ­é¸æŠã—ã¦ãã ã•ã„`);
                return;
            }
            
            const prediction = {
                predictor_name: name,
                bet_type: betType,
                numbers: [...selectedNumbers]
            };
            
            try {
                const response = await fetch(`${API_BASE}/predictions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(prediction)
                });
                
                if (response.ok) {
                    await fetchPredictions();
                    closeModal();
                } else {
                    const error = await response.json();
                    alert('äºˆæƒ³ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.error);
                }
            } catch (error) {
                console.error('äºˆæƒ³è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                alert('äºˆæƒ³ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function renderPredictions() {
            const grid = document.getElementById('predictionsGrid');
            grid.innerHTML = '';
            
            predictions.forEach(pred => {
                const card = document.createElement('div');
                card.className = 'prediction-card';
                
                let horsesHTML = '';
                pred.numbers.forEach((num, index) => {
                    const horse = horses.find(h => h.number === num);
                    if (horse) {
                        const position = pred.bet_type === '3é€£å˜' ? `${index + 1}ç€äºˆæƒ³` : '';
                        horsesHTML += `
                            <div class="horse-info">
                                <div class="horse-info-header">
                                    <div class="horse-number-badge">${horse.number}</div>
                                    <div class="horse-name">${horse.name}</div>
                                    <div class="horse-odds">${horse.odds}å††</div>
                                </div>
                                <div class="horse-theme">${horse.theme}</div>
                                ${position ? `<div style="margin-left: 40px; color: #8B4513; font-weight: bold; font-size: 0.85em; margin-top: 5px;">${position}</div>` : ''}
                            </div>
                        `;
                    }
                });
                
                card.innerHTML = `
                    <div class="prediction-header">
                        <div class="prediction-author">${pred.predictor_name}</div>
                        <div class="prediction-type">${pred.bet_type}</div>
                    </div>
                    ${horsesHTML}
                `;
                
                grid.appendChild(card);
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
            if (tabName === 'shutsuba') {
                fetchHorses();
            } else if (tabName === 'yosou') {
                fetchPredictions();
            } else if (tabName === 'kekka') {
                fetchResults();
            }
        }

        // åˆæœŸåŒ–
        async function init() {
            await fetchHorses();
            await fetchPredictions();
            await fetchResults();
        }

        init();
    </script>
</body>
</html>